// INVENTORY MAIN SCHEMA - ITEM, SUPPLIER, STOCK, BATCH, BUS, DISPOSAL, ORDER
// ============================================================================

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("INVENTORY_MAIN_DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum item_status {
ACTIVE
INACTIVE
}

enum stock_status {
INACTIVE
AVAILABLE
LOW_STOCK
OUT_OF_STOCK
NOT_AVAILABLE
UNDER_MAINTENANCE
EXPIRED
IN_USE
DISPOSED
}

enum bus_status {
ACTIVE
DECOMMISSIONED
UNDER_MAINTENANCE
}

enum bus_type {
AIRCONDITIONED
ORDINARY
}

enum bus_condition {
BRAND_NEW
SECOND_HAND
}

enum bus_source {
DEALERSHIP
AUCTION
PRIVATE_INDIVIDUAL
COMPANY_FLEET
}

enum acquisition_method {
PURCHASED
LEASED
DONATED
}

enum registration_status {
REGISTERED
NOT_REGISTERED
NEEDS_RENEWAL
EXPIRED
}

enum disposal_status {
PENDING
APPROVED
REJECTED
COMPLETED
}

enum disposal_method {
SOLD
SCRAPPED
DONATED
TRANSFERRED
WRITTEN_OFF
}

enum order_status {
  PENDING                           // PR approved, order generated
  IN_PROGRESS                       // Order list printed
  COMPLETED                         // All items received
  PARTIALLY_COMPLETED               // Some items missing/damaged
  PROCESSING_REFUND                 // Refund underway (synced from Finance)
  PROCESSING_REPLACEMENT            // Replacement underway (synced from Finance)
  PROCESSING_REFUND_AND_REPLACEMENT // Mixed refund/replacement (synced from Finance)
  REFUNDED                          // Refund completed (synced from Finance)
  REPLACED                          // Replacement completed
  REFUNDED_AND_REPLACED             // Mixed completed
  WRITE_OFF                         // Loss absorbed (synced from Finance)
  CLOSED                            // No further actions
}

enum order_item_status {
  PENDING                 // PR approved, item in order
  IN_PROGRESS             // Order list printed
  COMPLETED               // Item received
  PARTIALLY_COMPLETED     // Item partially received
  TO_BE_REFUNDED          // Refund expected (synced from Finance)
  TO_BE_REPLACED          // Replacement expected (synced from Finance)
  REFUNDED                // Item refunded (synced from Finance)
  REPLACED                // Item replaced
  WRITE_OFF               // Loss absorbed (synced from Finance)
  CLOSED                  // Item processing complete
}

enum replacement_status {
  PENDING                 // PR approved, item in order
  IN_PROGRESS             // Order list printed
  COMPLETED               // Item received
  PARTIALLY_COMPLETED     // Item partially received
  TO_BE_REFUNDED          // Refund expected (synced from Finance)
  TO_BE_REPLACED          // Replacement expected (synced from Finance)
  REFUNDED                // Item refunded (synced from Finance)
  REPLACED                // Item replaced
  WRITE_OFF               // Loss absorbed (synced from Finance)
  CLOSED                  // Item processing complete
}

// ============================================================================
// 1. ITEM MANAGEMENT (Core)
// ============================================================================

model category {
id            Int       @id @default(autoincrement())
category_code String    @unique
category_name String
description   String?   @db.Text

// Audit Trail
created_by    String?
created_at    DateTime  @default(now())
updated_by    String?
updated_at    DateTime  @updatedAt
deleted_by    String?
deleted_at    DateTime?
is_deleted    Boolean   @default(false)

// Relations
items         item[]

@@index([category_code])
@@index([is_deleted])
}

model unit_measure {
id             Int             @id @default(autoincrement())
unit_code      String          @unique
unit_name      String
abbreviation   String?
description    String?         @db.Text

// Audit Trail
created_by     String?
created_at     DateTime        @default(now())
updated_by     String?
updated_at     DateTime        @updatedAt
deleted_by     String?
deleted_at     DateTime?
is_deleted     Boolean         @default(false)

// Relations
items          item[]
supplier_items supplier_item[]

@@index([unit_code])
@@index([is_deleted])
}

model item {
id          Int          @id @default(autoincrement())
item_code   String       @unique
item_name   String
category_id Int
unit_id     Int
status      item_status  @default(ACTIVE)
description String?      @db.Text

// Audit Trail
created_by  String?
created_at  DateTime     @default(now())
updated_by  String?
updated_at  DateTime     @updatedAt
deleted_by  String?
deleted_at  DateTime?
is_deleted  Boolean      @default(false)

// Relations
category       category        @relation(fields: [category_id], references: [id])
unit           unit_measure    @relation(fields: [unit_id], references: [id])
supplier_items supplier_item[]
stocks         stock[]
disposals      disposal[]

@@index([item_code])
@@index([category_id])
@@index([unit_id])
@@index([status, is_deleted])
@@index([is_deleted])
}

// ============================================================================
// 2. SUPPLIER MANAGEMENT
// ============================================================================

model supplier {
id             Int             @id @default(autoincrement())
supplier_code  String          @unique
supplier_name  String
contact_number String?
email          String?
street         String?
barangay       String?
city           String?
province       String?
status         item_status     @default(ACTIVE)
description    String?         @db.Text

// Audit Trail
created_by     String?
created_at     DateTime        @default(now())
updated_by     String?
updated_at     DateTime        @updatedAt
deleted_by     String?
deleted_at     DateTime?
is_deleted     Boolean         @default(false)

// Relations
supplier_items supplier_item[]

@@index([supplier_code])
@@index([status, is_deleted])
}

model supplier_item {
supplier_id       Int
item_id           Int
supplier_unit_id  Int
conversion_amount Decimal  @db.Decimal(12, 4)
unit_price        Decimal  @db.Decimal(12, 2)
description       String?  @db.Text

last_purchase_price     Decimal?  @db.Decimal(12, 2)  // Track last actual purchase price
last_purchase_date      DateTime?                      // When this price was last updated

// Audit Trail
created_by        String?
created_at        DateTime @default(now())
updated_by        String?
updated_at        DateTime @updatedAt
deleted_by        String?
deleted_at        DateTime?
is_deleted        Boolean  @default(false)

// Relations
supplier          supplier     @relation(fields: [supplier_id], references: [id])
item              item         @relation(fields: [item_id], references: [id])
supplier_unit     unit_measure @relation(fields: [supplier_unit_id], references: [id])

@@unique([supplier_id, item_id])
@@index([supplier_id])
@@index([item_id])
@@index([is_deleted])
@@index([last_purchase_date])
}

// ============================================================================
// 3. STOCK MANAGEMENT
// ============================================================================

model stock {
id            Int              @id @default(autoincrement())
item_id       Int
current_stock Decimal          @db.Decimal(12, 2) @default(0)
reorder_level Decimal          @db.Decimal(12, 2) @default(0)
status        stock_status @default(INACTIVE)

// Audit Trail
created_by    String?
created_at    DateTime         @default(now())
updated_by    String?
updated_at    DateTime         @updatedAt
deleted_by    String?
deleted_at    DateTime?
is_deleted    Boolean          @default(false)

// Relations
item          item             @relation(fields: [item_id], references: [id])
batches       batch[]
disposals     disposal[]
buses         bus[]

@@unique([item_id])
@@index([item_id])
@@index([status, is_deleted])
@@index([current_stock])
}

model batch {
id                  Int       @id @default(autoincrement())
stock_id            Int
batch_number        String?
usable_quantity     Decimal   @db.Decimal(12, 2) @default(0)
defective_quantity  Decimal   @db.Decimal(12, 2) @default(0)
missing_quantity    Decimal   @db.Decimal(12, 2) @default(0)
expiration_date     DateTime?
received_date       DateTime  @default(now())
description         String?   @db.Text

is_replacement      Boolean   @default(false)
original_batch_id   Int?      // Always points to the very first batch
replaces_batch_id   Int?      // Points to immediate predecessor
replacement_status  replacement_status?
replacement_date    DateTime?

// Audit Trail
created_by          String?
created_at          DateTime  @default(now())
updated_by          String?
updated_at          DateTime  @updatedAt
deleted_by          String?
deleted_at          DateTime?
is_deleted          Boolean   @default(false)

// Relations
stock               stock     @relation(fields: [stock_id], references: [id])
disposals           disposal[]
external_order_ref  String?   // Should reference order.order_code
purchase_request_ref String?  // Should reference purchase_request.request_code

@@index([stock_id])
@@index([external_order_ref])
@@index([batch_number])
@@index([received_date])
@@index([expiration_date])
@@index([purchase_request_ref])
@@index([is_deleted])
}

// ============================================================================
// 4. BUS MANAGEMENT (Fixed Assets - Enhanced for Finance Integration)
// ============================================================================

model body_builder {
id                Int      @id @default(autoincrement())
body_builder_code String   @unique
body_builder_name String
description       String?  @db.Text

// Audit Trail
created_by        String?
created_at        DateTime @default(now())
updated_by        String?
updated_at        DateTime @updatedAt
deleted_by        String?
deleted_at        DateTime?
is_deleted        Boolean  @default(false)

// Relations
buses             bus[]

@@index([body_builder_code])
@@index([is_deleted])
}

model manufacturer {
id                 Int      @id @default(autoincrement())
manufacturer_code  String   @unique
manufacturer_name  String
description        String?  @db.Text

// Audit Trail
created_by         String?
created_at         DateTime @default(now())
updated_by         String?
updated_at         DateTime @updatedAt
deleted_by         String?
deleted_at         DateTime?
is_deleted         Boolean  @default(false)

// Relations
buses              bus[]

@@index([manufacturer_code])
@@index([is_deleted])
}

model bus {
id                        Int                   @id @default(autoincrement())
stock_id                  Int?
plate_number              String                @unique
body_number               String                @unique
body_builder_id           Int
bus_type                  bus_type
manufacturer_id           Int
status                    bus_status            @default(ACTIVE)
chassis_number            String?
engine_number             String?
seat_capacity             Int?
model                     String?
year_model                Int?
condition                 bus_condition
acquisition_date          DateTime?
acquisition_method        acquisition_method
warranty_expiration_date  DateTime?
registration_status       registration_status?

// Audit Trail
created_by                String?
created_at                DateTime              @default(now())
updated_by                String?
updated_at                DateTime              @updatedAt
deleted_by                String?
deleted_at                DateTime?
is_deleted                Boolean               @default(false)

// Relations
stock                     stock?                @relation(fields: [stock_id], references: [id], onDelete: SetNull)
body_builder              body_builder          @relation(fields: [body_builder_id], references: [id])
manufacturer              manufacturer          @relation(fields: [manufacturer_id], references: [id])
second_hand_details       second_hand_details?
brand_new_details         brand_new_details?
disposals                 disposal[]

@@index([plate_number])
@@index([body_number])
@@index([status, is_deleted])
@@index([condition])
@@index([is_deleted])
}

model second_hand_details {
id                      Int        @id @default(autoincrement())
bus_id                  Int        @unique
previous_owner          String?
previous_owner_contact  String?
source                  bus_source
odometer_reading        Decimal?   @db.Decimal(12, 2)
last_registration_date  DateTime?
description             String?    @db.Text

// Audit Trail
created_by              String?
created_at              DateTime   @default(now())
updated_by              String?
updated_at              DateTime   @updatedAt
deleted_by              String?
deleted_at              DateTime?
is_deleted              Boolean    @default(false)

// Relations
bus                     bus        @relation(fields: [bus_id], references: [id], onDelete: Cascade)

@@index([bus_id])
@@index([source])
@@index([is_deleted])
}

model brand_new_details {
id             Int      @id @default(autoincrement())
bus_id         Int      @unique
dealer_name    String?
dealer_contact String?

// Audit Trail
created_by     String?
created_at     DateTime @default(now())
updated_by     String?
updated_at     DateTime @updatedAt
deleted_by     String?
deleted_at     DateTime?
is_deleted     Boolean  @default(false)

// Relations
bus            bus      @relation(fields: [bus_id], references: [id], onDelete: Cascade)

@@index([bus_id])
@@index([is_deleted])
}

// ============================================================================
// 5. DISPOSAL MANAGEMENT (Physical Asset Lifecycle - Enhanced for Finance)
// ============================================================================

model disposal {
id               Int              @id @default(autoincrement())
disposal_code    String           @unique
item_id          Int?
bus_id           Int?
batch_id         Int?
stock_id         Int?
quantity         Decimal?         @db.Decimal(12, 2)
disposal_date    DateTime
disposal_method  disposal_method
description      String?          @db.Text
estimated_value  Decimal?         @db.Decimal(12, 2)
actual_value     Decimal?         @db.Decimal(12, 2)
disposal_status  disposal_status  @default(PENDING)

// Audit Trail
created_by       String?
created_at       DateTime         @default(now())
updated_by       String?
updated_at       DateTime         @updatedAt
approved_by      String?
approved_at      DateTime?
rejected_by      String?
rejected_at      DateTime?
deleted_by       String?
deleted_at       DateTime?
is_deleted       Boolean          @default(false)

// Relations
item             item?            @relation(fields: [item_id], references: [id])
bus              bus?             @relation(fields: [bus_id], references: [id], onDelete: Restrict)
batch            batch?           @relation(fields: [batch_id], references: [id])
stock            stock?           @relation(fields: [stock_id], references: [id])

@@index([disposal_code])
@@index([item_id])
@@index([bus_id])
@@index([disposal_status, is_deleted])
@@index([disposal_date])
}

// ============================================================================
// ORDER MANAGEMENT (Moved from Microservices)
// ============================================================================

model order {
id                   Int          @id @default(autoincrement())
order_code           String       @unique @default(cuid())
purchase_request_ref String       // Reference to microservice purchase_request.request_code
status               order_status @default(PENDING)

// Stock Reference
external_batch_refs  String?      // JSON array of batch IDs created

// Audit Trail
created_by           String?
created_at           DateTime     @default(now())
updated_by           String?
updated_at           DateTime     @updatedAt
approved_by          String?
approved_at          DateTime?
closed_by            String?
closed_at            DateTime?
deleted_by           String?
deleted_at           DateTime?
is_deleted           Boolean      @default(false)

// Relations
items                order_item[]

@@index([order_code])
@@index([purchase_request_ref])
@@index([status])
@@index([is_deleted])
}

model order_item {
id                  Int       @id @default(autoincrement())
order_id            Int
external_item_ref   String    // References item.item_code from main schema
item_name           String    // Denormalized for performance
ordered_quantity    Decimal   @db.Decimal(12, 2)
ordered_unit_price  Decimal   @db.Decimal(12, 2)
ordered_total_price Decimal   @db.Decimal(12, 2)
order_item_status order_item_status @default(PENDING)

// Received quantities (for stock creation)
received_quantity   Decimal?  @db.Decimal(12, 2) @default(0)
actual_unit_price   Decimal?  @db.Decimal(12, 2)
actual_total_price  Decimal?  @db.Decimal(12, 2)

// For ISSUE tracking (needed for refund/replacement)
missing_quantity    Decimal?  @db.Decimal(12, 2) @default(0)
damaged_quantity    Decimal?  @db.Decimal(12, 2) @default(0)

supplier_code         String?   // Which supplier this item is from
supplier_name         String?   // Denormalized for display
supplier_item_ref     String?   // Supplier's item reference
supplier_unit_id      String?   // Supplier's unit of measure
conversion_amount     Decimal?  @db.Decimal(12, 4)  // Conversion ratio

// For stock batch creation
batch_number        String?
expiration_date     DateTime?
remarks             String?   @db.Text

// Audit Trail
created_at          DateTime  @default(now())
updated_at          DateTime  @updatedAt
is_deleted          Boolean   @default(false)

// Relations
order               order     @relation(fields: [order_id], references: [id], onDelete: Cascade)

@@index([order_id])
@@index([external_item_ref])
@@index([order_item_status])
@@index([is_deleted])
}

// ============================================================================
// UNIFIED ATTACHMENT MANAGEMENT
// ============================================================================

model attachment {
id          Int      @id @default(autoincrement())
entity_type String   // e.g., "BUS", "ORDER", "DISPOSAL", "PURCHASE_REQUEST"
entity_id   String   // The ID of the related entity (bus_id, order_code, etc.)
file_name   String
file_type   String   // jpeg, jpg, png, pdf, docx, etc.
file_url    String
file_size   Int?     // in bytes
description String?  @db.Text

// Audit Trail
uploaded_by String?
created_at  DateTime @default(now())
updated_at  DateTime @updatedAt
is_deleted  Boolean  @default(false)

@@index([entity_type, entity_id])
@@index([entity_type])
@@index([file_type])
@@index([is_deleted])
}

// END OF INVENTORY MAIN SCHEMA