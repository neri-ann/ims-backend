// INVENTORY MAIN SCHEMA - ITEM, SUPPLIER, STOCK, BATCH, BUS, DISPOSAL, ORDER
// ============================================================================

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum supplier_status {
ACTIVE
INACTIVE
}

enum item_status {
ACTIVE
INACTIVE
}

enum stock_status {
INACTIVE
AVAILABLE
LOW_STOCK
OUT_OF_STOCK
NOT_AVAILABLE
UNDER_MAINTENANCE
EXPIRED
IN_USE
DISPOSED
}

enum bus_status {
ACTIVE
DECOMMISSIONED
UNDER_MAINTENANCE
}

enum bus_type {
AIRCONDITIONED
ORDINARY
}

enum bus_condition {
BRAND_NEW
SECOND_HAND
}

enum bus_source {
DEALERSHIP
AUCTION
PRIVATE_INDIVIDUAL
COMPANY_FLEET
}

enum acquisition_method {
PURCHASED
LEASED
DONATED
}

enum registration_status {
REGISTERED
NOT_REGISTERED
NEEDS_RENEWAL
EXPIRED
}


enum disposal_method {
FOR_SALE
SCRAPPED
DONATED
TRANSFERRED
WRITTEN_OFF
}

enum order_status {
PENDING                           // PR approved, order generated
IN_PROGRESS                       // Order list printed
COMPLETED                         // All items received or no more actions to be taken
PARTIAL   // May kulang sa dumating,e.g. missing, damaged, incomplete
AWAITING_COMPLETION   // When finance took action ;  post PARTIALLY_COMPLETED
}

enum order_item_status {
PENDING              // PR approved, item added to order
IN_PROGRESS          // Order sent/printed, awaiting delivery
PARTIAL              // Delivered but mismatch: missing/damaged/incomplete
AWAITING_COMPLETION  // Finance has decided (refund/replacement) and follow-up order is ongoing
COMPLETED            // Fully resolved (received, refunded, replaced, or no action taken)
}


enum disposal_status {
PENDING     // under review of Finance
APPROVED   // apprvoed by finance
REJECTED    // rejected by Finance
PROCESSING // when Finance is currently processing the disposal sale (outside the system)
COMPLETED   // when finance recorded income AND inventory adjusted record
}

// ============================================================================
// 1. ITEM MANAGEMENT (Core)
// ============================================================================

model category {
id            Int       @id @default(autoincrement())
category_code String    @unique
category_name String
description   String?   @db.Text
is_deleted    Boolean   @default(false)

// Audit Trail
created_by    String?
created_at    DateTime  @default(now())
updated_by    String?
updated_at    DateTime  @updatedAt
deleted_by    String?
deleted_at    DateTime?

// Relations
items         item[]

@@index([category_code])
@@index([is_deleted])
}

model unit_measure {
id             Int             @id @default(autoincrement())
unit_code      String          @unique
unit_name      String
abbreviation   String?
description    String?         @db.Text
is_deleted     Boolean         @default(false)

// Audit Trail
created_by     String?
created_at     DateTime        @default(now())
updated_by     String?
updated_at     DateTime        @updatedAt
deleted_by     String?
deleted_at     DateTime?

// Relations
items          item[]
supplier_items supplier_item[]

@@index([unit_code])
@@index([is_deleted])
}

model item {
id          Int          @id @default(autoincrement())
item_code   String?       @unique
item_name   String?
category_id Int
unit_id     Int
status      item_status  @default(ACTIVE)
description String?      @db.Text
is_deleted  Boolean      @default(false)
is_recorded     Boolean   @default(true)
is_asset    Boolean   @default(false)

// Audit Trail
created_by  String?
created_at  DateTime     @default(now())
updated_by  String?
updated_at  DateTime     @updatedAt
deleted_by  String?
deleted_at  DateTime?

// Relations
category       category?       @relation(fields: [category_id], references: [id])
unit           unit_measure?    @relation(fields: [unit_id], references: [id])
supplier_items supplier_item[]
stocks         stock[]

@@index([item_code])
@@index([category_id])
@@index([unit_id])
@@index([status, is_deleted])
@@index([is_deleted])
}

// ============================================================================
// 2. SUPPLIER MANAGEMENT
// ============================================================================

model supplier {
id             Int             @id @default(autoincrement())
supplier_code  String          @unique
supplier_name  String
contact_number String?
email          String?
street         String?
barangay       String?
city           String?
province       String?
status         supplier_status     @default(ACTIVE)
description    String?         @db.Text
is_deleted     Boolean         @default(false)
is_recorded    Boolean         @default(true)

// Audit Trail
created_by     String?
created_at     DateTime        @default(now())
updated_by     String?
updated_at     DateTime        @updatedAt
deleted_by     String?
deleted_at     DateTime?

// Relations
supplier_items supplier_item[]

@@index([supplier_code])
@@index([status, is_deleted])
}

model supplier_item {
supplier_id       Int
item_id           Int
supplier_unit_id  Int
conversion_amount Decimal  @db.Decimal(12, 4)
unit_price        Decimal  @db.Decimal(12, 2)
description       String?  @db.Text
is_deleted        Boolean  @default(false)
is_recorded       Boolean  @default(true)

// Audit Trail
created_by        String?
created_at        DateTime @default(now())
updated_by        String?
updated_at        DateTime @updatedAt
deleted_by        String?
deleted_at        DateTime?

// Relations
supplier          supplier     @relation(fields: [supplier_id], references: [id])
item              item         @relation(fields: [item_id], references: [id])
supplier_unit     unit_measure @relation(fields: [supplier_unit_id], references: [id])

@@unique([supplier_id, item_id])
@@index([supplier_id])
@@index([item_id])
@@index([is_deleted])
}

// ============================================================================
// 3. STOCK MANAGEMENT
// ============================================================================

model stock {
id            Int              @id @default(autoincrement())
item_code    String
current_stock Decimal          @db.Decimal(12, 2) @default(0)
reorder_level Decimal          @db.Decimal(12, 2) @default(0)
status        stock_status @default(INACTIVE)
is_deleted    Boolean          @default(false)

// Audit Trail
created_by    String?
created_at    DateTime         @default(now())
updated_by    String?
updated_at    DateTime         @updatedAt
deleted_by    String?
deleted_at    DateTime?

// Relations
item          item             @relation(fields: [item_code], references: [item_code])
batches       batch[]
disposals     disposal[]

@@unique([item_code])
@@index([item_code])
@@index([status, is_deleted])
@@index([current_stock])
}

model batch {
id                  Int       @id @default(autoincrement())
stock_id            Int
batch_number        String?
quantity     Decimal   @db.Decimal(12, 2) @default(0)
expiration_date     DateTime?
received_date       DateTime  @default(now())
remarks         String?   @db.Text
is_deleted          Boolean   @default(false)

// Audit Trail
created_by          String?
created_at          DateTime  @default(now())
updated_by          String?
updated_at          DateTime  @updatedAt
deleted_by          String?
deleted_at          DateTime?

// Relations
stock               stock     @relation(fields: [stock_id], references: [id])
disposals           disposal[]
order_code  String?   // Should reference order.order_code

@@index([stock_id])
@@index([order_code])
@@index([batch_number])
@@index([received_date])
@@index([expiration_date])
@@index([is_deleted])
}

// ============================================================================
// 4. BUS MANAGEMENT (Fixed Assets - Enhanced for Finance Integration)
// ============================================================================

model body_builder {
id                Int      @id @default(autoincrement())
body_builder_code String   @unique
body_builder_name String
description       String?  @db.Text
is_deleted        Boolean  @default(false)

// Audit Trail
created_by        String?
created_at        DateTime @default(now())
updated_by        String?
updated_at        DateTime @updatedAt
deleted_by        String?
deleted_at        DateTime?

// Relations
buses             bus[]

@@index([body_builder_code])
@@index([is_deleted])
}

model manufacturer {
id                 Int      @id @default(autoincrement())
manufacturer_code  String   @unique
manufacturer_name  String
description        String?  @db.Text
is_deleted         Boolean  @default(false)

// Audit Trail
created_by         String?
created_at         DateTime @default(now())
updated_by         String?
updated_at         DateTime @updatedAt
deleted_by         String?
deleted_at         DateTime?

// Relations
buses              bus[]

@@index([manufacturer_code])
@@index([is_deleted])
}

model bus {
id                        Int                   @id @default(autoincrement())
bus_code  String   @unique
plate_number              String                @unique
body_number               String                @unique
body_builder_id           Int
bus_type                  bus_type
manufacturer_id           Int
status                    bus_status            @default(ACTIVE)
chassis_number            String?
engine_number             String?
seat_capacity             Int?
model                     String?
year_model                Int?
condition                 bus_condition
acquisition_cost          Decimal               @db.Decimal(12, 2)    @default(0)
acquisition_date          DateTime?
acquisition_method        acquisition_method
warranty_expiration_date  DateTime?
registration_status       registration_status?
is_deleted                Boolean               @default(false)
is_asset Boolean @default(true)

// Audit Trail
created_by                String?
created_at                DateTime              @default(now())
updated_by                String?
updated_at                DateTime              @updatedAt
deleted_by                String?
deleted_at                DateTime?

// Relations
body_builder              body_builder          @relation(fields: [body_builder_id], references: [id])
manufacturer              manufacturer          @relation(fields: [manufacturer_id], references: [id])
second_hand_details       second_hand_details?
brand_new_details         brand_new_details?
disposals                 disposal[]

@@index([plate_number])
@@index([body_number])
@@index([status, is_deleted])
@@index([condition])
@@index([is_deleted])
}

model second_hand_details {
id                      Int        @id @default(autoincrement())
bus_id                  Int        @unique
previous_owner          String?
previous_owner_contact  String?
source                  bus_source
odometer_reading        Decimal?   @db.Decimal(12, 2)
last_registration_date  DateTime?
description             String?    @db.Text
is_deleted              Boolean    @default(false)

// Audit Trail
created_by              String?
created_at              DateTime   @default(now())
updated_by              String?
updated_at              DateTime   @updatedAt
deleted_by              String?
deleted_at              DateTime?

// Relations
bus                     bus        @relation(fields: [bus_id], references: [id], onDelete: Cascade)

@@index([bus_id])
@@index([source])
@@index([is_deleted])
}

model brand_new_details {
id             Int      @id @default(autoincrement())
bus_id         Int      @unique
dealer_name    String?
dealer_contact String?
is_deleted     Boolean  @default(false)

// Audit Trail
created_by     String?
created_at     DateTime @default(now())
updated_by     String?
updated_at     DateTime @updatedAt
deleted_by     String?
deleted_at     DateTime?

// Relations
bus            bus      @relation(fields: [bus_id], references: [id], onDelete: Cascade)

@@index([bus_id])
@@index([is_deleted])
}

// ============================================================================
// 5. DISPOSAL MANAGEMENT (Physical Asset Lifecycle - Enhanced for Finance)
// ============================================================================

model disposal {
id               Int              @id @default(autoincrement())
disposal_code    String           @unique
bus_id           Int?
batch_id         Int?
stock_id         Int?
quantity         Decimal?         @db.Decimal(12, 2)
disposal_date    DateTime
disposal_method  disposal_method
description      String?          @db.Text
status   disposal_status   @default(PENDING)
is_deleted       Boolean          @default(false)

// Audit Trail
created_by       String?
created_at       DateTime         @default(now())
updated_by       String?
updated_at       DateTime         @updatedAt
approved_by      String?
approved_at      DateTime?
rejected_by      String?
rejected_at      DateTime?
deleted_by       String?
deleted_at       DateTime?

// Relations
bus              bus?             @relation(fields: [bus_id], references: [id], onDelete: Restrict)
batch            batch?           @relation(fields: [batch_id], references: [id])
stock            stock?           @relation(fields: [stock_id], references: [id])

@@index([disposal_code])
@@index([bus_id])
@@index([batch_id])
@@index([stock_id])
@@index([disposal_date])
}

// ============================================================================
// ORDER MANAGEMENT (Moved from Microservices)
// ============================================================================

model order {
id                   Int          @id @default(autoincrement())
order_code           String       @unique @default(cuid())
purchase_request_code   String       // Reference to microservice purchase_request.request_code
status               order_status @default(PENDING)
is_deleted           Boolean      @default(false)

// Audit Trail
created_by           String?
created_at           DateTime     @default(now())
updated_by           String?
updated_at           DateTime     @updatedAt
approved_by          String?
approved_at          DateTime?
closed_by            String?
closed_at            DateTime?
deleted_by           String?
deleted_at           DateTime?

// Relations
items                order_item[]

@@index([order_code])
@@index([purchase_request_code])
@@index([status])
@@index([is_deleted])
}

model order_item {
id                  Int       @id @default(autoincrement())
order_item_code  String   @unique
order_id            Int     // purchase_request_item > supplier_item : supplier and item data
ordered_quantity    Decimal   @db.Decimal(12, 2)
ordered_unit_price  Decimal   @db.Decimal(12, 2)
order_item_status order_item_status @default(PENDING)
actual_unit_price   Decimal?  @db.Decimal(12, 2)
is_deleted          Boolean   @default(false)
is_replacement   Boolean    @default(false)
old_order_id     Int?

// For ISSUE tracking (needed for refund/replacement)
usable_quantity   Decimal?  @db.Decimal(12, 2) @default(0)     // If ordered_quantity != usable_quantity, allow user to create a completion purchase request
missing_quantity    Decimal?  @db.Decimal(12, 2) @default(0)     // Official Receipt and Acquired Goods
damaged_quantity    Decimal?  @db.Decimal(12, 2) @default(0)     // Official Receipt and Acquired Goods
receipt_quantity      Decimal?  @db.Decimal(12, 2)  @default(0)     

// PATCHED by finance
refund_quantity    Decimal   @db.Decimal(12, 2)     // PATCHED by Finance
replace_quantity    Decimal   @db.Decimal(12, 2)     // PATCHED by Finance
no_action_quantity    Decimal   @db.Decimal(12, 2)     // PATCHED by Finance

// audit trail
created_by              String?
created_at              DateTime                  @default(now())
updated_by              String?
updated_at              DateTime                  @updatedAt
deleted_by              String?
deleted_at              DateTime?

// Relations
order               order     @relation(fields: [order_id], references: [id], onDelete: Cascade)

@@index([order_id])
@@index([order_item_status])
@@index([is_deleted])
}

// ============================================================================
// UNIFIED ATTACHMENT MANAGEMENT
// ============================================================================

model attachment {
id          Int      @id @default(autoincrement())
entity_type String   // e.g., "BUS", "ORDER", "DISPOSAL", "PURCHASE_REQUEST"
entity_id String // if referencing order_code, PR code, etc.
file_name   String
file_type   String   // jpeg, jpg, png, pdf, docx, etc.
file_url    String
file_size   Int?     // in bytes
description String?  @db.Text

// Audit Trail
uploaded_by String?
created_at  DateTime @default(now())
updated_at  DateTime @updatedAt
is_deleted  Boolean  @default(false)

@@index([entity_type, entity_id])
@@index([entity_type])
@@index([file_type])
@@index([is_deleted])
}

// END OF INVENTORY MAIN SCHEMA
