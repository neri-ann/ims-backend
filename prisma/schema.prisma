// INVENTORY MAIN SCHEMA - OPTIMIZED FOR FINANCE INTEGRATION
// Core Inventory Management with Clear Domain Boundaries
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("INVENTORY_DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ItemStatus {
  ACTIVE
  INACTIVE
}

enum InventoryStatus {
  INACTIVE
  AVAILABLE
  LOW_STOCK
  OUT_OF_STOCK
  NOT_AVAILABLE
  UNDER_MAINTENANCE
  EXPIRED
  IN_USE
  DISPOSED
}

enum BusStatus {
  ACTIVE
  DECOMMISSIONED
  UNDER_MAINTENANCE
}

enum BusType {
  AIRCONDITIONED
  ORDINARY
}

enum BusCondition {
  BRAND_NEW
  SECOND_HAND
}

enum BusSource {
  DEALERSHIP
  AUCTION
  PRIVATE_INDIVIDUAL
  COMPANY_FLEET
}

enum AcquisitionMethod {
  PURCHASED
  LEASED
  DONATED
}

enum RegistrationStatus {
  REGISTERED
  NOT_REGISTERED
  NEEDS_RENEWAL
  EXPIRED
}

enum DisposalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum DisposalMethod {
  SOLD
  SCRAPPED
  DONATED
  TRANSFERRED
  WRITTEN_OFF
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIALLY_COMPLETED
  TO_BE_REFUNDED
  TO_BE_REPLACED
  CLOSED
}

// ============================================================================
// 1. ITEM MANAGEMENT (Core)
// ============================================================================

model Category {
  id           Int         @id @default(autoincrement())
  categoryCode String      @unique
  categoryName String
  description  String?     @db.Text

  // Audit Trail
  createdBy    String?
  createdAt    DateTime    @default(now())
  updatedBy    String?
  updatedAt    DateTime    @updatedAt
  deletedBy    String?
  deletedAt    DateTime?
  isDeleted    Boolean     @default(false)

  // Relations
  items        Item[]

  @@index([categoryCode])
  @@index([isDeleted])
}

model UnitMeasure {
  id           Int            @id @default(autoincrement())
  unitCode     String         @unique
  unitName     String
  abbreviation String?
  description  String?        @db.Text

  // Audit Trail
  createdBy    String?
  createdAt    DateTime       @default(now())
  updatedBy    String?
  updatedAt    DateTime       @updatedAt
  deletedBy    String?
  deletedAt    DateTime?
  isDeleted    Boolean        @default(false)

  // Relations
  items        Item[]
  supplierItems SupplierItem[]

  @@index([unitCode])
  @@index([isDeleted])
}

model Item {
  id           Int           @id @default(autoincrement())
  itemCode     String        @unique
  itemName     String
  categoryId   Int
  unitId       Int
  status       ItemStatus    @default(ACTIVE)
  description  String?       @db.Text

  // Audit Trail
  createdBy    String?
  createdAt    DateTime      @default(now())
  updatedBy    String?
  updatedAt    DateTime      @updatedAt
  deletedBy    String?
  deletedAt    DateTime?
  isDeleted    Boolean       @default(false)

  // Relations
  category         Category           @relation(fields: [categoryId], references: [id])
  unit             UnitMeasure        @relation(fields: [unitId], references: [id])
  supplierItems    SupplierItem[]
  stocks           Stock[]
  disposals        Disposal[]

  @@index([itemCode])
  @@index([categoryId])
  @@index([unitId])
  @@index([status, isDeleted])
  @@index([isDeleted])
}

// ============================================================================
// 2. SUPPLIER MANAGEMENT
// ============================================================================

model Supplier {
  id            Int          @id @default(autoincrement())
  supplierCode  String       @unique
  supplierName  String
  contactNumber String?
  email         String?
  street        String?
  barangay      String?
  city          String?
  province      String?
  status        ItemStatus   @default(ACTIVE)
  description   String?      @db.Text

  // Audit Trail
  createdBy     String?
  createdAt     DateTime     @default(now())
  updatedBy     String?
  updatedAt     DateTime     @updatedAt
  deletedBy     String?
  deletedAt     DateTime?
  isDeleted     Boolean      @default(false)

  // Relations
  supplierItems SupplierItem[]

  @@index([supplierCode])
  @@index([status, isDeleted])
}

model SupplierItem {
  supplierId        Int
  itemId            Int
  supplierUnitId    Int
  conversionAmount  Decimal  @db.Decimal(12, 4)
  unitPrice         Decimal  @db.Decimal(12, 2)
  description       String?  @db.Text

  // Audit Trail
  createdBy         String?
  createdAt         DateTime @default(now())
  updatedBy         String?
  updatedAt         DateTime @updatedAt
  deletedBy         String?
  deletedAt         DateTime?
  isDeleted         Boolean  @default(false)

  // Relations
  supplier          Supplier     @relation(fields: [supplierId], references: [id])
  item              Item         @relation(fields: [itemId], references: [id])
  supplierUnit      UnitMeasure  @relation(fields: [supplierUnitId], references: [id])

  @@unique([supplierId, itemId])
  @@index([supplierId])
  @@index([itemId])
  @@index([isDeleted])
}

// ============================================================================
// 3. STOCK MANAGEMENT
// ============================================================================

model Stock {
  id            Int             @id @default(autoincrement())
  itemId        Int
  currentStock  Decimal         @db.Decimal(12, 2) @default(0)
  reorderLevel  Decimal         @db.Decimal(12, 2) @default(0)
  status        InventoryStatus @default(INACTIVE)

  // Audit Trail
  createdBy     String?
  createdAt     DateTime        @default(now())
  updatedBy     String?
  updatedAt     DateTime        @updatedAt
  deletedBy     String?
  deletedAt     DateTime?
  isDeleted     Boolean         @default(false)

  // Relations
  item          Item            @relation(fields: [itemId], references: [id])
  batches       Batch[]
  disposals     Disposal[]
  buses         Bus[]

  @@unique([itemId])
  @@index([itemId])
  @@index([status, isDeleted])
  @@index([currentStock])
}

model Batch {
  id                Int      @id @default(autoincrement())
  stockId           Int
  batchNumber       String?
  usableQuantity    Decimal  @db.Decimal(12, 2) @default(0)
  defectiveQuantity Decimal  @db.Decimal(12, 2) @default(0)
  missingQuantity   Decimal  @db.Decimal(12, 2) @default(0)
  expirationDate    DateTime?
  receivedDate      DateTime @default(now())
  description       String?  @db.Text

  // Audit Trail
  createdBy         String?
  createdAt         DateTime @default(now())
  updatedBy         String?
  updatedAt         DateTime @updatedAt
  deletedBy         String?
  deletedAt         DateTime?
  isDeleted         Boolean  @default(false)

  // Relations
  stock             Stock @relation(fields: [stockId], references: [id])
  disposals         Disposal[]
  externalOrderRef  String?  // Should reference Order.orderCode
  purchaseRequestRef String? // Should reference PurchaseRequest.requestCode

  @@index([stockId])
  @@index([externalOrderRef])
  @@index([batchNumber])
  @@index([receivedDate])
  @@index([expirationDate])
  @@index([purchaseRequestRef])
  @@index([isDeleted])
}

// ============================================================================
// 4. BUS MANAGEMENT (Fixed Assets - Enhanced for Finance Integration)
// ============================================================================

model BodyBuilder {
  id               Int      @id @default(autoincrement())
  bodyBuilderCode  String   @unique
  bodyBuilderName  String
  description      String?  @db.Text

  // Audit Trail
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedBy        String?
  updatedAt        DateTime @updatedAt
  deletedBy        String?
  deletedAt        DateTime?
  isDeleted        Boolean  @default(false)

  // Relations
  buses            Bus[]

  @@index([bodyBuilderCode])
  @@index([isDeleted])
}

model Manufacturer {
  id               Int      @id @default(autoincrement())
  manufacturerCode String   @unique
  manufacturerName String
  description      String?  @db.Text

  // Audit Trail
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedBy        String?
  updatedAt        DateTime @updatedAt
  deletedBy        String?
  deletedAt        DateTime?
  isDeleted        Boolean  @default(false)

  // Relations
  buses            Bus[]

  @@index([manufacturerCode])
  @@index([isDeleted])
}

model Dealer {
  id            Int      @id @default(autoincrement())
  dealerCode    String   @unique
  dealerName    String
  contactNumber String?
  email         String?
  address       String?  @db.Text
  description   String?  @db.Text

  // Audit Trail
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedBy     String?
  updatedAt     DateTime @updatedAt
  deletedBy     String?
  deletedAt     DateTime?
  isDeleted     Boolean  @default(false)

  // Relations
  brandNewDetails BrandNewDetails[]

  @@index([dealerCode])
  @@index([isDeleted])
}

model Bus {
  id                      Int               @id @default(autoincrement())
  stockId                 Int?
  plateNumber             String            @unique
  bodyNumber              String            @unique
  bodyBuilderId           Int
  busType                 BusType
  manufacturerId          Int
  status                  BusStatus         @default(ACTIVE)
  chassisNumber           String?
  engineNumber            String?
  seatCapacity            Int?
  model                   String?
  yearModel               Int?
  condition               BusCondition
  acquisitionDate         DateTime?
  acquisitionMethod       AcquisitionMethod
  warrantyExpirationDate  DateTime?
  registrationStatus      RegistrationStatus?

  // Audit Trail
  createdBy               String?
  createdAt               DateTime          @default(now())
  updatedBy               String?
  updatedAt               DateTime          @updatedAt
  deletedBy               String?
  deletedAt               DateTime?
  isDeleted               Boolean           @default(false)

  // Relations
  stock                   Stock?          @relation(fields: [stockId], references: [id], onDelete: SetNull)
  bodyBuilder             BodyBuilder     @relation(fields: [bodyBuilderId], references: [id])
  manufacturer            Manufacturer    @relation(fields: [manufacturerId], references: [id])
  secondHandDetails       SecondHandDetails?
  brandNewDetails         BrandNewDetails?
  disposals               Disposal[]

  @@index([plateNumber])
  @@index([bodyNumber])
  @@index([status, isDeleted])
  @@index([condition])
  @@index([isDeleted])
}

model SecondHandDetails {
  id                    Int         @id @default(autoincrement())
  busId                 Int         @unique
  previousOwner         String?
  previousOwnerContact  String?
  source                BusSource
  odometerReading       Decimal?    @db.Decimal(12, 2)
  lastRegistrationDate  DateTime?
  description           String?     @db.Text

  // Audit Trail
  createdBy             String?
  createdAt             DateTime    @default(now())
  updatedBy             String?
  updatedAt             DateTime    @updatedAt
  deletedBy             String?
  deletedAt             DateTime?
  isDeleted             Boolean     @default(false)

  // Relations
  bus                   Bus         @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([busId])
  @@index([source])
  @@index([isDeleted])
}

model BrandNewDetails {
  id        Int      @id @default(autoincrement())
  busId     Int      @unique
  dealerId  Int

  // Audit Trail
  createdBy String?
  createdAt DateTime @default(now())
  updatedBy String?
  updatedAt DateTime @updatedAt
  deletedBy String?
  deletedAt DateTime?
  isDeleted Boolean  @default(false)

  // Relations
  bus       Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  dealer    Dealer   @relation(fields: [dealerId], references: [id])

  @@index([busId])
  @@index([dealerId])
  @@index([isDeleted])
}

// ============================================================================
// 5. DISPOSAL MANAGEMENT (Physical Asset Lifecycle - Enhanced for Finance)
// ============================================================================

model Disposal {
  id               Int            @id @default(autoincrement())
  disposalCode     String         @unique
  itemId           Int?
  busId            Int?
  batchId          Int?
  stockId          Int?
  quantity         Decimal?       @db.Decimal(12, 2)
  disposalDate     DateTime
  disposalMethod   DisposalMethod
  description      String?        @db.Text
  estimatedValue   Decimal?       @db.Decimal(12, 2)
  actualValue      Decimal?       @db.Decimal(12, 2)
  disposalStatus   DisposalStatus @default(PENDING)

  // Audit Trail
  createdBy        String?
  createdAt        DateTime       @default(now())
  updatedBy        String?
  updatedAt        DateTime       @updatedAt
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  deletedBy        String?
  deletedAt        DateTime?
  isDeleted        Boolean        @default(false)

  // Relations
  item             Item?          @relation(fields: [itemId], references: [id])
  bus              Bus?           @relation(fields: [busId], references: [id], onDelete: Restrict)
  batch            Batch?         @relation(fields: [batchId], references: [id])
  stock            Stock?         @relation(fields: [stockId], references: [id])

  @@index([disposalCode])
  @@index([itemId])
  @@index([busId])
  @@index([disposalStatus, isDeleted])
  @@index([disposalDate])
}

// ============================================================================
// ORDER MANAGEMENT (Moved from Microservices)
// ============================================================================

model Order {
  id                    Int         @id @default(autoincrement())
  orderCode             String      @unique @default(cuid())
  purchaseRequestRef    String      // Reference to microservice PurchaseRequest.requestCode
  status                OrderStatus @default(PENDING)

  // Stock Reference
  externalBatchRefs     String?     // JSON array of batch IDs created

  // Audit Trail
  createdBy             String?
  createdAt             DateTime    @default(now())
  updatedBy             String?
  updatedAt             DateTime    @updatedAt
  approvedBy            String?
  approvedAt            DateTime?
  closedBy              String?
  closedAt              DateTime?
  deletedBy             String?
  deletedAt             DateTime?
  isDeleted             Boolean     @default(false)

  // Relations
  items                 OrderItem[]

  @@index([orderCode])
  @@index([purchaseRequestRef])
  @@index([status])
  @@index([isDeleted])
}

model OrderItem {
  id                    Int      @id @default(autoincrement())
  orderId               Int
  externalItemRef       String   // References Item.itemCode from main schema
  itemName              String   // Denormalized for performance
  orderedQuantity       Decimal  @db.Decimal(12, 2)
  orderedUnitPrice      Decimal  @db.Decimal(12, 2)
  orderedTotalPrice     Decimal  @db.Decimal(12, 2)

  // Received quantities (for stock creation)
  receivedQuantity      Decimal? @db.Decimal(12, 2) @default(0)
  actualUnitPrice       Decimal? @db.Decimal(12, 2)
  actualTotalPrice      Decimal? @db.Decimal(12, 2)

  // For ISSUE tracking (needed for refund/replacement)
  missingQuantity       Decimal? @db.Decimal(12, 2) @default(0)
  damagedQuantity       Decimal? @db.Decimal(12, 2) @default(0)

  // For stock batch creation
  batchNumber           String?
  expirationDate        DateTime?

  remarks               String?  @db.Text

  // Audit Trail
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  isDeleted             Boolean  @default(false)

  // Relations
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([externalItemRef])
  @@index([isDeleted])
}

// ============================================================================
// UNIFIED ATTACHMENT MANAGEMENT
// ============================================================================

model Attachment {
  id              Int      @id @default(autoincrement())
  entityType      String   // e.g., "BUS", "ORDER", "DISPOSAL", "PURCHASE_REQUEST"
  entityId        String   // The ID of the related entity (busId, orderCode, etc.)
  fileName        String
  fileType        String   // jpeg, jpg, png, pdf, docx, etc.
  fileUrl         String
  fileSize        Int?     // in bytes
  description     String?  @db.Text

  // Audit Trail
  uploadedBy      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  isDeleted       Boolean  @default(false)

  @@index([entityType, entityId])
  @@index([entityType])
  @@index([fileType])
  @@index([isDeleted])
}

// END OF INVENTORY MAIN SCHEMA
